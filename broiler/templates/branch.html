{% extends "base.html" %}

{% block title %}Manage Branches{% endblock %}

{% block content %}

 <!-- Toggle Navbar -->
 <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-4">
    <div class="container-fluid">
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#subNavbar"
        aria-controls="subNavbar"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="subNavbar">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'branch_list' %}">Branch</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#supervisor-section">Supervisor</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#broilerplace-section">Broiler Place</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#broilerfarm-section">Broiler Farm</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#broilerbatch-section">Broiler Batch</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#broilerdisease-section">Broiler Disease</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-cstm mt-5">
    <h2 class="text-center mb-4">Manage Branches</h2>
    
    <div class="row g-5">
      <!-- Form Section (Top) -->
      <div class="col-6 mx-auto">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 id="form-title" class="mb-0">Add New Branch</h5>
          </div>
          <div class="card-body">
            <form id="branch-form">
              {% csrf_token %}
              <input type="hidden" id="branch-id" />
              <div class="mb-3">
                <label for="state" class="form-label">State</label>
                <input
                  type="text"
                  id="state"
                  class="form-control"
                  placeholder="Enter state"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="branch_name" class="form-label">Branch Name</label>
                <input
                  type="text"
                  id="branch_name"
                  class="form-control"
                  placeholder="Enter branch name"
                  required
                />
              </div>
              <div class="d-flex justify-content-between ">
                <button type="submit" class="btn btn-success mx-auto">
                  Save
                </button>
                <button
                  type="button"
                  id="cancel-button"
                  class="btn btn-secondary d-none"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
  
      <!-- List Section (Bottom) -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Branch List</h5>
          </div>
          <div class="card-body">
            <table
              class="table table-striped table-hover table-bordered"
              id="branch-table"
            >
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>State</th>
                  <th>Branch Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- AJAX content will load here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% comment %} <script>
  // Fetch CSRF token from the template
  const csrfToken = "{{ csrf_token }}";

  // Function to load branches via AJAX
  function loadBranches() {
    $.get("{% url 'branch_list' %}", function (data) {
      let rows = "";
      data.forEach(function (branch) {
        rows += `
          <tr>
            <td>${branch.id}</td>
            <td>${branch.state}</td>
            <td>${branch.branch_name}</td>
            <td>
              <button class="btn btn-warning btn-sm edit-button" data-id="${branch.id}" data-state="${branch.state}" data-branch-name="${branch.branch_name}">Edit</button>
              <button class="btn btn-danger btn-sm delete-button" data-id="${branch.id}">Delete</button>
            </td>
          </tr>
        `;
      });
      $("#branch-table tbody").html(rows);
    });
  }

  // Load branches when the page is ready
  $(document).ready(function () {
    loadBranches();

    // Handle form submission for Create or Update
    $("#branch-form").on("submit", function (event) {
      event.preventDefault();
      const id = $("#branch-id").val();
      const state = $("#state").val();
      const branchName = $("#branch_name").val();

      const url = id ? `{% url 'branch_edit' id %}` : "{% url 'branch_list' %}";
      const method = id ? "PUT" : "POST";

      $.ajax({
        url: url,
        method: method,
        headers: { "X-CSRFToken": csrfToken },
        data: { state: state, branch_name: branchName },
        success: function () {
          loadBranches();
          $("#branch-form")[0].reset();
          $("#form-title").text("Add New Branch");
          $("#cancel-button").addClass("d-none");
          alert("Branch saved successfully!");
        },
        error: function () {
          alert("An error occurred while saving the branch.");
        },
      });
    });

    // Handle Edit button click
    $(document).on("click", ".edit-button", function () {
      const id = $(this).data("id");
      const state = $(this).data("state");
      const branchName = $(this).data("branch-name");

      $("#branch-id").val(id);
      $("#state").val(state);
      $("#branch_name").val(branchName);
      $("#form-title").text("Edit Branch");
      $("#cancel-button").removeClass("d-none");
    });

    // Handle Cancel button click
    $("#cancel-button").on("click", function () {
      $("#branch-form")[0].reset();
      $("#branch-id").val("");
      $("#form-title").text("Add New Branch");
      $(this).addClass("d-none");
    });

    // Handle Delete button click
    $(document).on("click", ".delete-button", function () {
      const id = $(this).data("id");

      if (confirm("Are you sure you want to delete this branch?")) {
        $.ajax({
          url: `{% url 'branch_delete' %}`.replace("0", id),
          method: "DELETE",
          headers: { "X-CSRFToken": csrfToken },
          success: function () {
            loadBranches();
            alert("Branch deleted successfully!");
          },
          error: function () {
            alert("An error occurred while deleting the branch.");
          },
        });
      }
    });
  });
</script> {% endcomment %}
{% endblock %}
